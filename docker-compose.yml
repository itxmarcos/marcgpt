services:
  # ===== OpenClaw Gateway =====
  openclaw-gateway:
    image: alpine/openclaw:latest
    container_name: marcgpt-openclaw
    restart: unless-stopped
    user: "0"
    init: true
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      MOONSHOT_API_KEY: ${MOONSHOT_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_OWNER_ID: ${TELEGRAM_OWNER_ID}
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      NOTION_DATABASE_ID: ${NOTION_DATABASE_ID:-}
      CLOCKIFY_API_KEY: ${CLOCKIFY_API_KEY:-}
      CLOCKIFY_WORKSPACE_ID: ${CLOCKIFY_WORKSPACE_ID:-}
    volumes:
      - ./src/main/openclaw:/home/node/.openclaw
    ports:
      - "18789:18789"
      - "18790:18790"
    networks:
      - marcgpt-net
    command: ["sh", "-c", "chown -R 1000:1000 /home/node/.openclaw/workspace && exec su -s /bin/sh -c 'exec node dist/index.js gateway --bind lan --port 18789' node"]

  # ===== OpenClaw CLI (on-demand, not started by default) =====
  openclaw-cli:
    image: alpine/openclaw:latest
    container_name: marcgpt-openclaw-cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      MOONSHOT_API_KEY: ${MOONSHOT_API_KEY}
      BROWSER: "echo"
    volumes:
      - ./src/main/openclaw:/home/node/.openclaw
    stdin_open: true
    tty: true
    init: true
    networks:
      - marcgpt-net
    entrypoint: ["node", "dist/index.js"]
    profiles:
      - cli

  # ===== PostgreSQL (for n8n) =====
  postgres:
    image: postgres:16-alpine
    container_name: marcgpt-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_NON_ROOT_USER: ${POSTGRES_NON_ROOT_USER}
      POSTGRES_NON_ROOT_PASSWORD: ${POSTGRES_NON_ROOT_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./src/main/n8n/init-data.sh:/docker-entrypoint-initdb.d/init-data.sh
    networks:
      - marcgpt-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ===== n8n Workflow Automation =====
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: marcgpt-n8n
    restart: unless-stopped
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_NON_ROOT_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_NON_ROOT_PASSWORD}
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      N8N_SECURE_COOKIE: "false"
      N8N_LICENSE_ACTIVATION_KEY: ${N8N_LICENSE_KEY:-}
      WEBHOOK_URL: ${WEBHOOK_URL}
    ports:
      - "5678:5678"
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - marcgpt-net
    depends_on:
      postgres:
        condition: service_healthy

  # ===== Focus Sessions Sync (on-demand) =====
  focus-sessions:
    build:
      context: ./src/main/focus-sessions
      dockerfile: Dockerfile
    container_name: marcgpt-focus-sessions
    environment:
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      NOTION_DATABASE_ID: ${NOTION_DATABASE_ID:-}
      CLOCKIFY_API_KEY: ${CLOCKIFY_API_KEY:-}
      CLOCKIFY_WORKSPACE_ID: ${CLOCKIFY_WORKSPACE_ID:-}
    networks:
      - marcgpt-net
    profiles:
      - cli

volumes:
  postgres-data:
  n8n-data:

networks:
  marcgpt-net:
    driver: bridge
